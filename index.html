<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoSender MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      font-family: Arial, sans-serif;
    }
    
    .shape-container {
      display: flex;
      gap: 30px;
      margin: 30px 0;
    }
    
    .shape-btn {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .shape-btn:hover {
      transform: scale(1.1);
    }
    
    .circle {
      border-radius: 50%;
      background: #FF5252;
    }
    
    .triangle {
      width: 0;
      height: 0;
      border-left: 40px solid transparent;
      border-right: 40px solid transparent;
      border-bottom: 70px solid #4CAF50;
    }
    
    .square {
      background: #FFC107;
    }
    
    #videoPreview {
      width: 100%;
      max-width: 400px;
      background: black;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .timer {
      font-size: 24px;
      margin: 15px 0;
    }
    
    .send-btn {
      background: #7c4dff;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Геометрический видеосендер</h1>
  
  <div class="shape-container">
    <div class="shape-btn circle" id="circleBtn">●</div>
    <div class="shape-btn triangle" id="triangleBtn"></div>
    <div class="shape-btn square" id="squareBtn">◼</div>
  </div>
  
  <video id="videoPreview" muted playsinline></video>
  
  <div class="timer" id="timer">00:00</div>
  
  <button class="send-btn" id="sendBtn" disabled>Отправить видео</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    const videoElement = document.getElementById('videoPreview');
    const timerElement = document.getElementById('timer');
    const sendBtn = document.getElementById('sendBtn');
    
    let mediaRecorder;
    let recordedChunks = [];
    let timerInterval;
    let seconds = 0;
    
    // Доступ к камере
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });
        videoElement.srcObject = stream;
      } catch (err) {
        console.error("Camera error:", err);
        tg.showPopup({ title: "Ошибка", message: "Доступ к камере запрещен" });
      }
    }
    
    // Начать запись
    function startRecording(shape) {
      if (!videoElement.srcObject) return;
      
      recordedChunks = [];
      seconds = 0;
      updateTimer();
      
      mediaRecorder = new MediaRecorder(videoElement.srcObject);
      
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      
      mediaRecorder.onstop = () => {
        sendBtn.disabled = false;
      };
      
      mediaRecorder.start();
      
      // Таймер
      timerInterval = setInterval(() => {
        seconds++;
        updateTimer();
      }, 1000);
      
      // Визуальный эффект
      document.body.style.background = shape === 'circle' 
        ? 'linear-gradient(135deg, #ff5252 0%, #ff7675 100%)'
        : shape === 'triangle'
          ? 'linear-gradient(135deg, #4CAF50 0%, #81C784 100%)'
          : 'linear-gradient(135deg, #FFC107 0%, #FFD54F 100%)';
    }
    
    // Остановить запись
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
      }
    }
    
    // Обновить таймер
    function updateTimer() {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      timerElement.textContent = `${mins}:${secs}`;
    }
    
    // Отправить видео
    async function sendVideo() {
      tg.showPopup({ 
        title: "Отправка", 
        message: "Видео отправляется..." 
      }, () => {});
      
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      
      // Создаем временную ссылку
      const url = URL.createObjectURL(blob);
      
      // Отправляем через Telegram API
      tg.sendData(JSON.stringify({
        type: 'video',
        content: url,
        timestamp: Date.now()
      }));
      
      // Очищаем ресурсы
      setTimeout(() => {
        URL.revokeObjectURL(url);
        tg.close();
      }, 3000);
    }
    
    // Инициализация
    initCamera();
    
    // Назначение обработчиков
    document.getElementById('circleBtn').addEventListener('click', () => startRecording('circle'));
    document.getElementById('triangleBtn').addEventListener('click', () => startRecording('triangle'));
    document.getElementById('squareBtn').addEventListener('click', () => startRecording('square'));
    
    document.addEventListener('mouseup', stopRecording);
    document.addEventListener('touchend', stopRecording);
    
    sendBtn.addEventListener('click', sendVideo);
  </script>
</body>
</html>
