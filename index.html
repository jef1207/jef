<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic Road Racer</title>
    <style>
        /* Сохраняем предыдущие стили и добавляем новые */
        body { 
            /* ... предыдущие стили ... */
            perspective: 1000px;
        }
        .road-line {
            position: absolute;
            width: 20px;
            height: 80px;
            background: white;
            transform-origin: bottom center;
        }
        .speed-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,0.1) 0%,
                rgba(0,0,0,0.2) 50%,
                rgba(255,255,255,0.1) 100%);
            opacity: 0;
        }
    </style>
</head>
<body>
    <!-- ... предыдущая разметка ... -->

    <script>
        // Добавляем новые параметры в CONFIG
        const CONFIG = {
            // ... предыдущие настройки ...
            ROAD_MOVEMENT: {
                speed: 3,
                lines: [],
                lastLineTime: 0
            },
            CAR_EFFECTS: {
                shakeIntensity: 1.5,
                tiltAngle: 8,
                trailLength: 20
            },
            VISUAL_EFFECTS: {
                speedLines: true,
                roadVibration: true,
                dynamicCamera: true
            }
        };

        // Добавляем новые переменные
        let roadOffset = 0;
        let carTrail = [];
        let shakeOffset = { x: 0, y: 0 };
        let tiltAngle = 0;

        function updateRoadMovement() {
            // Движение дороги
            roadOffset += CONFIG.ROAD_MOVEMENT.speed;
            if(roadOffset > 100) roadOffset = 0;
            
            // Создание линий разметки
            const now = Date.now();
            if(now - CONFIG.ROAD_MOVEMENT.lastLineTime > 100) {
                CONFIG.ROAD_MOVEMENT.lines.push({
                    x: ROAD.getLaneCenter(Math.floor(Math.random() * CONFIG.ROAD.lanes)),
                    y: -50
                });
                CONFIG.ROAD_MOVEMENT.lastLineTime = now;
            }
        }

        function updateCarEffects() {
            // Тряска машины
            if(CONFIG.VISUAL_EFFECTS.roadVibration) {
                shakeOffset.x = Math.sin(Date.now() * 0.05) * CONFIG.CAR_EFFECTS.shakeIntensity;
                shakeOffset.y = Math.cos(Date.now() * 0.03) * CONFIG.CAR_EFFECTS.shakeIntensity;
            }
            
            // Наклон при повороте
            tiltAngle *= 0.9; // Плавный возврат к исходному положению
        }

        function drawRoadLines() {
            // Отрисовка движущихся линий разметки
            ctx.save();
            ctx.translate(0, roadOffset);
            CONFIG.ROAD_MOVEMENT.lines.forEach((line, index) => {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(
                    line.x - 5,
                    line.y + index * 150,
                    10,
                    50
                );
            });
            ctx.restore();
        }

        function drawCarWithEffects() {
            // Эффекты для машины игрока
            ctx.save();
            ctx.translate(
                player.x + player.width/2 + shakeOffset.x,
                player.y + shakeOffset.y
            );
            ctx.rotate(tiltAngle * Math.PI / 180);
            
            // Основной корпус
            ctx.fillStyle = player.color;
            ctx.fillRect(
                -player.width/2,
                -player.height/2,
                player.width,
                player.height
            );
            
            // След от шин
            if(carTrail.length > 0) {
                ctx.beginPath();
                ctx.moveTo(
                    -player.width/2,
                    -player.height/2 + player.height
                );
                carTrail.forEach((pos, i) => {
                    ctx.lineTo(
                        pos.x + Math.sin(i * 0.5) * 3,
                        pos.y + i * 2
                    );
                });
                ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            ctx.restore();
        }

        function movePlayer(direction) {
            // Добавляем эффект наклона при повороте
            tiltAngle = direction * CONFIG.CAR_EFFECTS.tiltAngle;
            
            // Сохраняем позиции для следа
            carTrail.unshift({
                x: player.x + player.width/2,
                y: player.y + player.height
            });
            if(carTrail.length > CONFIG.CAR_EFFECTS.trailLength) carTrail.pop();
            
            // Обновляем позицию игрока
            player.lane = Math.max(0, Math.min(CONFIG.ROAD.lanes - 1, player.lane + direction));
            player.updatePosition();
        }

        function drawSpeedEffect() {
            if(CONFIG.VISUAL_EFFECTS.speedLines) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.2})`;
                for(let i = 0; i < 20; i++) {
                    ctx.beginPath();
                    ctx.arc(
                        Math.random() * canvas.width,
                        Math.random() * canvas.height,
                        Math.random() * 3,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
        }

        function updateGame() {
            // Обновляем все эффекты
            updateRoadMovement();
            updateCarEffects();
            // ... остальная логика ...
        }

        function draw() {
            // Отрисовываем все эффекты
            drawRoadLines();
            drawCarWithEffects();
            drawSpeedEffect();
            // ... остальная отрисовка ...
        }

        // ... остальной код ...
    </script>
</body>
</html>
