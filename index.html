<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальная часть head без изменений) ... -->
    <style>
        /* ... (остальные стили без изменений) ... */
        
        /* Добавим анимацию для частиц */
        @keyframes particleAnimation {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- ... (остальная часть HTML без изменений) ... -->
    
    <script>
        // Инициализация игры только после взаимодействия с пользователем
        let gameInitialized = false;
        
        // Функция для инициализации игры
        function initGame() {
            if (gameInitialized) return;
            gameInitialized = true;
            
            // Элементы DOM
            const gameArea = document.getElementById('gameArea');
            const scoreDisplay = document.getElementById('score');
            const levelDisplay = document.getElementById('level');
            const targetsDisplay = document.getElementById('targets');
            const timeDisplay = document.getElementById('time');
            const gameMessage = document.getElementById('gameMessage');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const restartBtn = document.getElementById('restartBtn');
            
            // Игровые переменные
            let score = 0;
            let level = 1;
            let targetsClicked = 0;
            let gameActive = false;
            let gameSpeed = 1500; // интервал появления мишеней (мс)
            let gameTime = 60; // время игры в секундах
            let targetTimer;
            let gameTimer;
            let timeTimer;
            let targets = [];
            let lastLevelUpScore = 0; // Для отслеживания перехода уровней
            
            const colors = [
                // ... (цвета без изменений) ...
            ];
            
            // Инициализация игры
            function initGameSession() {
                score = 0;
                level = 1;
                targetsClicked = 0;
                gameTime = 60;
                lastLevelUpScore = 0;
                scoreDisplay.textContent = score;
                levelDisplay.textContent = level;
                targetsDisplay.textContent = targetsClicked;
                timeDisplay.textContent = gameTime;
                gameActive = true;
                gameMessage.style.display = 'none';
                
                // Очистка игровой области
                gameArea.querySelectorAll('.target').forEach(t => t.remove());
                targets = [];
                
                // Запуск таймеров
                startGameTimers();
            }
            
            // Запуск игровых таймеров
            function startGameTimers() {
                // Таймер создания мишеней
                targetTimer = setInterval(createTarget, gameSpeed);
                
                // Таймер времени игры
                timeTimer = setInterval(() => {
                    if (!gameActive) return;
                    
                    gameTime--;
                    timeDisplay.textContent = gameTime;
                    
                    if (gameTime <= 0) {
                        endGame();
                    }
                }, 1000);
                
                // Таймер уровня (ИСПРАВЛЕННЫЙ ТАЙМЕР УРОВНЯ)
                gameTimer = setInterval(() => {
                    if (!gameActive) return;
                    
                    // Повышаем уровень каждые 15 очков, но только один раз за переход
                    if (score >= lastLevelUpScore + 15) {
                        increaseLevel();
                        lastLevelUpScore = score;
                    }
                }, 1000);
            }
            
            // Создание мишени
            function createTarget() {
                if (!gameActive) return;
                
                const target = document.createElement('div');
                target.className = 'target';
                
                // ... (размер и позиция без изменений) ...
                
                // Обработчик клика (ИСПРАВЛЕННАЯ АНИМАЦИЯ ЧАСТИЦ)
                target.addEventListener('click', () => {
                    if (!gameActive) return;
                    
                    // Увеличиваем счет
                    score += level;
                    targetsClicked++;
                    scoreDisplay.textContent = score;
                    targetsDisplay.textContent = targetsClicked;
                    
                    // Создаем эффект частиц (ИСПРАВЛЕННОЕ ПОЗИЦИОНИРОВАНИЕ)
                    createParticles(target);
                    
                    // ... (остальная часть обработчика клика без изменений) ...
                });
            }
            
            // Создание эффекта частиц (ИСПРАВЛЕННАЯ ФУНКЦИЯ)
            function createParticles(target) {
                const rect = target.getBoundingClientRect();
                const gameAreaRect = gameArea.getBoundingClientRect();
                
                // Правильное вычисление позиции относительно игровой области
                const centerX = rect.left - gameAreaRect.left + rect.width / 2;
                const centerY = rect.top - gameAreaRect.top + rect.height / 2;
                const color = window.getComputedStyle(target).background;
                
                // Создаем 10 частиц
                for (let i = 0; i < 10; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    // ... (размер и цвет без изменений) ...
                    
                    // Начальная позиция относительно gameArea
                    particle.style.left = `${centerX}px`;
                    particle.style.top = `${centerY}px`;
                    
                    // Добавляем частицу в игровую область
                    gameArea.appendChild(particle);
                    
                    // Случайное направление и расстояние
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 80 + 40;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    
                    // Используем CSS анимацию для производительности
                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);
                    particle.style.animation = `particleAnimation 0.8s forwards`;
                    
                    // Удаляем частицу после анимации
                    setTimeout(() => {
                        particle.remove();
                    }, 800);
                }
            }
            
            // ... (остальные функции без изменений) ...
        }
        
        // Инициализация при первом взаимодействии
        document.body.addEventListener('touchstart', initGame, {once: true});
        document.body.addEventListener('mousedown', initGame, {once: true});
        document.body.addEventListener('click', initGame, {once: true});
    </script>
</body>
</html>
