<!DOCTYPE html>
<html>
<head>
    <title>Cube Quest - Простая 3D Игра</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
        }
        #game-ui {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 100;
            font-size: 18px;
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #00ff00;
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 100;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-size: 36px;
            z-index: 200;
            display: none;
        }
        #restart-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #008800;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
        }
        #restart-btn:hover {
            background: #00aa00;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,255,0,0.7);
        }
    </style>
</head>
<body>
    <div id="game-ui">Счёт: <span id="score">0</span> | Время: <span id="timer">60</span></div>
    <div id="instructions">Управление: ← → ↑ ↓ или WASD | Собери все треугольники!</div>
    <div id="game-over">
        <div>ИГРА ОКОНЧЕНА!</div>
        <div>Ваш счёт: <span id="final-score">0</span></div>
        <button id="restart-btn">Играть снова</button>
    </div>

    <script>
        // Основные переменные игры
        let scene, camera, renderer, player;
        let crystals = [];
        let score = 0;
        let gameTime = 60;
        let gameActive = true;
        
        // Инициализация игры
        function init() {
            // 1. Создание сцены
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            // 2. Настройка камеры
            camera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.set(0, 8, 12);
            camera.lookAt(0, 0, 0);
            
            // 3. Создание рендерера
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // 4. Освещение
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 5. Создание игрока (зелёный куб)
            const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
            const playerMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x00ff00,
                shininess: 100,
                emissive: 0x003300
            });
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.y = 0.5;
            player.castShadow = true;
            scene.add(player);
            
            // 6. Создание пола
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x333333,
                shininess: 30
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // 7. Создание кристаллов (красные треугольные пирамиды)
            function createCrystal(x, z) {
                const geometry = new THREE.ConeGeometry(0.6, 1.2, 3);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0xff0000,
                    emissive: 0x330000,
                    shininess: 90
                });
                const crystal = new THREE.Mesh(geometry, material);
                
                crystal.position.x = x;
                crystal.position.z = z;
                crystal.position.y = 0.6;
                crystal.castShadow = true;
                
                scene.add(crystal);
                crystals.push(crystal);
                return crystal;
            }
            
            // Начальные кристаллы
            createCrystal(-5, -5);
            createCrystal(5, -5);
            createCrystal(-5, 5);
            createCrystal(5, 5);
            createCrystal(0, 0);
            
            // 8. Обработчики событий
            document.addEventListener('keydown', handleKeyDown);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            
            // 9. Запуск игрового цикла
            animate();
        }
        
        // Обработка нажатий клавиш
        function handleKeyDown(event) {
            if (!gameActive) return;
            
            const speed = 0.2;
            const boundary = 8.5; // Граница игрового поля
            
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (player.position.z > -boundary) player.position.z -= speed;
                    break;
                    
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (player.position.z < boundary) player.position.z += speed;
                    break;
                    
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (player.position.x > -boundary) player.position.x -= speed;
                    break;
                    
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (player.position.x < boundary) player.position.x += speed;
                    break;
            }
        }
        
        // Обновление игрового состояния
        function updateGame() {
            if (!gameActive) return;
            
            // 1. Проверка сбора кристаллов
            crystals.forEach((crystal, index) => {
                // Вращение кристалла
                crystal.rotation.y += 0.02;
                
                // Проверка расстояния между игроком и кристаллом
                const dx = player.position.x - crystal.position.x;
                const dz = player.position.z - crystal.position.z;
                const distance = Math.sqrt(dx*dx + dz*dz);
                
                // Если игрок рядом с кристаллом
                if (distance < 1.5) {
                    // Удаляем кристалл
                    scene.remove(crystal);
                    crystals.splice(index, 1);
                    
                    // Добавляем очки
                    score += 10;
                    document.getElementById('score').textContent = score;
                    
                    // Создаем новый кристалл на краю поля
                    const side = Math.floor(Math.random() * 4);
                    let x = 0, z = 0;
                    
                    switch(side) {
                        case 0: x = -8; z = Math.random() * 16 - 8; break; // Левая сторона
                        case 1: x = 8; z = Math.random() * 16 - 8; break;  // Правая сторона
                        case 2: x = Math.random() * 16 - 8; z = -8; break; // Верхняя сторона
                        case 3: x = Math.random() * 16 - 8; z = 8; break;  // Нижняя сторона
                    }
                    
                    createCrystal(x, z);
                }
            });
            
            // 2. Обновление таймера
            gameTime -= 0.016; // ~60 FPS
            document.getElementById('timer').textContent = Math.ceil(gameTime);
            
            // 3. Проверка окончания времени
            if (gameTime <= 0) {
                endGame();
            }
        }
        
        // Завершение игры
        function endGame() {
            gameActive = false;
            document.getElementById('final-score').textContent = score;
            document.getElementById('game-over').style.display = 'flex';
        }
        
        // Перезапуск игры
        function restartGame() {
            // Удаляем все кристаллы
            crystals.forEach(crystal => scene.remove(crystal));
            crystals = [];
            
            // Сбрасываем игровые параметры
            score = 0;
            gameTime = 60;
            gameActive = true;
            
            document.getElementById('score').textContent = '0';
            document.getElementById('timer').textContent = '60';
            document.getElementById('game-over').style.display = 'none';
            
            // Возвращаем игрока в центр
            player.position.x = 0;
            player.position.z = 0;
            
            // Создаем новые кристаллы
            createCrystal(-5, -5);
            createCrystal(5, -5);
            createCrystal(-5, 5);
            createCrystal(5, 5);
            createCrystal(0, 0);
        }
        
        // Анимация и рендеринг
        function animate() {
            requestAnimationFrame(animate);
            updateGame();
            renderer.render(scene, camera);
        }
        
        // Обработка изменения размера окна
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Запуск игры при загрузке
        window.onload = init;
    </script>
</body>
</html>
