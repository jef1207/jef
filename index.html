<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cube Collector MVP</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style> 
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        } 
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #gameCanvas { 
            display: block; 
            width: 100%;
            height: 100%;
            background: #000;
        }
        #uiContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            color: white;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
        }
        .debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="uiContainer">
            <div id="userName"></div>
            <div id="scoreBoard">Счет: 0</div>
            <div id="timer">30</div>
        </div>
        <div class="debug-info">DEBUG: Инициализация...</div>
    </div>
    <!-- Используем CDN вместо модулей для простоты -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 1. Проверка загрузки Three.js
        if(!window.THREE) {
            document.querySelector('.debug-info').textContent = 'Ошибка: Three.js не загружен!';
            throw new Error("Three.js not loaded");
        }

        // 2. Инициализация Telegram Web App
        const tg = window.Telegram && Telegram.WebApp;
        if(!tg) {
            document.querySelector('.debug-info').textContent = 'Ошибка: Telegram API не загружен!';
        } else {
            tg.ready();
        }

        // Элементы DOM
        const userNameEl = document.getElementById('userName');
        const scoreBoardEl = document.getElementById('scoreBoard');
        const timerEl = document.getElementById('timer');
        const canvas = document.getElementById('gameCanvas');
        const debugInfo = document.querySelector('.debug-info');

        // Проверка элементов
        if(!canvas) {
            debugInfo.textContent = 'Ошибка: Canvas не найден!';
            throw new Error("Canvas element not found");
        }

        // 3. Покажем имя пользователя
        if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            userNameEl.textContent = `Игрок: ${user.first_name || 'Аноним'}`;
        } else {
            userNameEl.textContent = 'Игрок: Демо-режим';
        }

        // 4. Настройка Three.js
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        // Камера с хорошим обзором
        const camera = new THREE.PerspectiveCamera(
            60, 
            window.innerWidth / window.innerHeight, 
            0.1, 
            1000
        );
        camera.position.set(0, 5, 10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            antialias: true,
            alpha: false
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        debugInfo.textContent = `WebGL: ${renderer.capabilities.isWebGL ? 'Да' : 'Нет'}, Three.js v${THREE.REVISION}`;

        // 5. Освещение
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(3, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // 6. Пол
        const floorGeometry = new THREE.PlaneGeometry(20, 20);
        const floorMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x336633,
            shininess: 30
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -0.5;
        scene.add(floor);

        // 7. Добавим тестовый куб сразу
        const testCubeGeometry = new THREE.BoxGeometry(1, 1, 1);
        const testCubeMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xff0000,
            wireframe: false
        });
        const testCube = new THREE.Mesh(testCubeGeometry, testCubeMaterial);
        testCube.position.set(0, 0.5, 0);
        scene.add(testCube);
        debugInfo.textContent += ' | Тестовый куб добавлен';

        // 8. Игровые переменные
        let score = 0;
        let timeLeft = 30;
        let gameActive = false;
        const cubes = [];
        const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);

        // 9. Функция анимации
        function animate() {
            requestAnimationFrame(animate);
            
            // Анимация тестового куба
            testCube.rotation.x += 0.01;
            testCube.rotation.y += 0.01;
            
            renderer.render(scene, camera);
        }
        animate();

        // 10. Обработка ресайза
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize);

        // 11. Отладка
        console.log("Three.js initialized:", THREE);
        console.log("Scene objects:", scene.children);
    </script>
</body>
</html>
